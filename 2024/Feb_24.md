## February 1st

- [x] Link to school setsu indexes from charts setsu_table (seasonal site)
- [x] Add required validations to all forms
- [x] Add the ability to destroy lessons
- [x] And restrict it if they're used in a course

### [Materials](https://github.com/Brett-Tanner/materials)

#### Users

- [x] Show the password_confirmation field since autogenerated passwords are editable
- [x] Set up actual shared examples for auth, not just redefining the same thing at the top of every file
- System test for creating each user as lowest permissioned user who can
  - [x] OrgAdmin
  - [x] SM
  - [x] Teacher
- Create & test pundit policy for each user type
  - [x] OrgAdminPolicy
  - [x] SchoolManagerPolicy
  - [x] TeacherPolicy
- Create a controller if missing
  - [x] OrgAdminController
  - [x] SchoolManagerController
  - [x] TeacherController
- Scaffold user views so I can test out how STI links work with Pundit
  - Nav for each type
    - [x] OrgAdmin
    - [x] SM
    - [x] Teacher
  - Show for each type
    - [x] OrgAdmin
    - [x] SM
    - [x] Teacher
  - Form partial for each type
    - [x] OrgAdmin
    - [x] SM
      - [x] Show at least one managements selection if none currently attached
    - [x] Teacher
      - [x] Create & test SchoolPolicy

## February 2nd

- [x] Install Mission Control
- [x] Add the totals back to the setsu table (maybe did it on live branch??)
- [x] Added some percentages in a hopeless attempt to avoid another tiny change in two days
- [x] Finish off the WP search

### [Materials](https://github.com/Brett-Tanner/materials)

### Lessons

- [x] Untangle the info I got from Daniel about required fields for each lesson type
- [x] Condense any fields that are basically the same
- [x] Migrate in all the new Lesson columns
- Rename Course#name to title for consistency
  - [x] Change the migration
  - [x] Find and replace all the code that uses Course.name
- Create the resources I can for those lesson types
  - Create/Modify factories & validity tests for all lesson types
    - [x] DailyActivity
    - [x] EnglishClass
    - [x] Exercise
    - [x] Phonics
  - [x] Modify existing models/controllers for new default lesson fields

## February 5th

- 2 online lessons

### [Materials](https://github.com/Brett-Tanner/materials)

### Lessons

- [x] Make another attempt at generating the PDF in a model callback, not a controller

  - Ended up creating the blob independently then assigning it with = rather than attach to avoid saves

- Shared lesson behaviour
  - [x] steppable concern might need to be made more generic so it can create an array for any col
    - Renamed to listable and had it include #listify, which needs to be manually called for each array attr
  - [x] icon path generation
    - also remove the default in the factory
- [x] Move PDF generation code into concerns
- Create shared pdf component modules
  - [x] Header
  - [x] NumList

## February 6th

- [x] Get Togoshi photo kids data for Leroy

### [Materials](https://github.com/Brett-Tanner/materials)

### Lessons

- [x] Create somewhere for all the PDF code to include/inherit defaults from
- [x] Iterate over listable attrs in Listable concern, get the attrs from class constant
- [x] Format the date in filename gen to remove spaces
- [x] Move the concern tests into their own spec files rather than shared examples

- [x] Create shared pdf defaults component modules
  - padding
  - gap
  - heading size
  - base font size
- [x] Use the defaults in existing code
- Create shared pdf component modules
  - [x] Links
  - [x] Add optional subtitle to PdfHeader
  - [x] DotList
- [x] consider using a tempfile for images uploaded just for PDF creation instead of ActiveStorage
  - Especially since AS way seems to not be working right now
  - Did come up with a way of doing this, but regenerating pdfs would be an issue
  - As images would only be stored in PDF
  - Went back to has_one_attached, but the image was not available to add to the PDF before saving
  - So eventually settled for queueing a job to generate the PDF after create or update in LessonsController
  - Couldn't use a model callback as it triggered the callback recursively
- Models/Factories
  - [x] DailyActivity
  - [x] EnglishClass
- Necessary tests
  - DailyActivity
    - [x] Update system spec
  - EnglishClass
    - [x] Valid factory
    - [x] Topic string creation
    - [x] System test
- Views/Strong params/Controllers
  - [x] DailyActivity
    - [x] Change step_fields partial to more generic list_fields that accepts a symbol
  - [x] EnglishClass
- PDF libs
  - [x] DailyActivity

## February 7th

- [x] Figure out how to dump & restore the dev database from my latop cos some idiot reset the one on my desktop -\_\_-
- [x] Add area filtering to Seasonal site stats
- [x] Convert the nav to .haml while I'm there
- [x] Notice there's no 'automated message' warning on the setsu emails and add it
- [x] Remove Shin-urayasu & minamimachida arrival options

### [Materials](https://github.com/Brett-Tanner/materials)

### Lessons

- [x] Extract the display of listable attributes into a partial
- [x] Use it in the existing lesson show partials

- Necessary tests
  - [x] Exercise
  - [x] Phonics
  - [x] StandShowSpeak
- Models/Factories
  - [x] Exercise
  - [x] Phonics
  - [x] StandShowSpeak
- Views/Strong params/Controllers
  - DailyActivity
    - [x] Update the daily_activity partial for show
  - [x] Exercise
  - [x] Phonics
  - [x] StandShowSpeak
- PDF libs
  - [x] EnglishClass
    - For this one I just need to allow one to be uploaded directly instead
  - [x] Exercise
  - [x] Phonics
  - [x] StandShowSpeak
    - No guide for this one
    - So replaced it with a thumb of the script

## February 8th

### [Materials](https://github.com/Brett-Tanner/materials)

- [x] Install Turbo 8.0

### Lessons

- [x] Add all these new lesson types to seeds file
- [x] Switch back to immediately generating guides in controller callback rather than job
- [x] Update system specs for guide being immediately generated
- [x] Update controllers for guide being immediately generated
- [x] Check if I actually need the `guide.purge` in LessonsController anymore
- PDF images
  - [x] Guide image field partial
  - [x] Use 'accept' attribute to limit to jpg/png
  - [x] Model validations
  - [x] Extract pdf image logic into module
- Create lesson approval mechanisms
  - [x] Create migrations for new columns on lessons
  - [x] And the factories
  - Add creator/assigned relations
    - [x] Set creator and assigned to current user on creation
    - [x] Add creator/assigned to Lesson views
    - [x] Add list of created/assigned lessons to Writer/Admin views

## February 9th

- [x] Change the wording of the setsumeikai inquiry email

### [Materials](https://github.com/Brett-Tanner/materials)

### Lessons

- Create lesson approval mechanisms
  - Add creator/assigned relations
    - [x] On lesson, allow changing assigned user
    - On writer/admin profile, allow assigning all lessons to another user
      - [x] Write & test Lesson.reassign_editor
      - [x] Add the form/controller/route to call it
      - [x] Set/test policy for User#reassign_editor
      - [x] Strong params on creator/assigned editor ids
        - Evolved into limiting Writers to only curriculum_approval attr since all else will be through proposed changes
  - [x] Display internal comments/ability to add to them
  - Requires some number of curriculum & admin approvals
    - [x] Write tests for approvals
    - [x] Track the approvals for each in an array of { user_id: id, user_name: Name, date: Timestamp } hashes
    - [x] Don't allow multiple approvals from the same person
  - [x] Add #approved? method
    - [x] Add released/approved badge to #show/index
    - [x] Add released/approved toggle to #show/index (remember different approvals for admin/writer)
    - [x] Extract badges to their own partial for re-use on index
    - [x] Change Lessons#index view to use a table for better organised status/toggles
    - [x] Move toggles into their own partial
- Separate proposed changes table
  - Only used when updating, writers can create lessons as normal as they're not immediately released
  - Handle whether to create a lesson or proposed change in the controller based on user role
  - Probably common code in lesson controller and inherit it with super to sub controllers
  - [x] Migrate
  - [x] Create system spec
  - [x] Create model
  - [x] Update LessonsController to automatically create proposed changes if user is a writer
  - [x] Display proposed changes on Lesson#show
  - [x] Give admins a reject button for each proposed change

## February 10th

## [Materials](https://github.com/Brett-Tanner/materials)

### Deployment

- [x] Install brakeman & lock production gem versions
- [x] Switch to Ruby 3.3.0
- [x] Enable YJIT
- [x] Get the Docker image building succesfully

### Lessons

- [x] Create & test ProposedChangePolicy
- [x] Give admins an 'Apply changes' button for each proposed change
  - use the update action

## February 11th

- [x] Add a time_slots table dump to the admin panel for Daniel

## [Materials](https://github.com/Brett-Tanner/materials)

### Deployment

- Get the Docker image running succesfully
  - [x] Resolve poppler related errors

### Lessons

- [x] Add comments and rejected boolean to proposed changes
- [x] Reject doesn't destroy, just marks it as rejected
- [x] Change rejected boolean to status enum
- [x] Show changes on the profile of the writer who proposed them, sorted by status
- [x] Allow adding comments to proposed changes & selecting change status
- [x] Update ProposedChangePolicy & tests
- Allow editing proposed changes directly
  - [x] Give up and just duplicate the relevant lesson columns in proposed change table
  - [x] Update tests
  - [x] Editing a proposed change should take you to the relevant lesson form with the proposed change info prefilled
    - Probably create a new Lesson from the proposed change info in ProposedChangeController#edit

## February 12th-16th

No idea where these entries went???? I know Thursday I was in the office and this repo wasn't synced to Github, but no clue about the others.

## February 19th

## [Materials](https://github.com/Brett-Tanner/materials)

- [x] Hide areas/prefectures that are empty on main site school search

### Deployment

- Get the Docker image running succesfully
  - [x] Resolve lack of postgres server in dev env
  - [x] Optimise the image for prod
  - [x] Try out using Docker for development as well
    - Dismissed as having multiple Dockerfiles/compose.ymls is annoying and Bun tailwind updates didn't work
  - [x] Try and get an Alpine Docker image running
    - Gave up after multiple rounds of failing to install Poppler-related dependencies. Damn PDFs.
- Figure out the actual process of deployment
  - [x] Try just pushing the Docker image to Elastic Beanstalk
    - Didn't work, Elastic Beanstalk can't read the Ruby version inside ${} so hardcoded it
    - Fixed some other small things and got it to 'succeed', but in actuality it timed out and couldn't be interacted with
    - May have been related to me starting a new env while the old one was terminating, and RDS being decoupled on that old one

## February 20th

- Various stuff to get my P-UP AWS account set up
  - [x] Log in and test switching to provided role
  - [x] Check/get necessary permissions
  - [x] Ask for IAM-related permissions for CLI/EB service role
    - Temporarily granted, if I need to change them/create a new environment I'll need to ask for them again
  - [x] Set up eb cli, and profile to assume the correct role
  - [x] Add my ssh key and successfully ssh to the instance

#### Sales/OrgAdmin

- [x] Update DB Schema on Lucidchart
- Scaffold Schools, Students & Classes
  - Migrate Tables
    - Schools
      - [x] Join table for teachers
    - [x] Classes
      - [x] Join table for teachers
    - [x] Students
      - [x] Enable DB encryption so names aren't stored in plaintext
      - [x] Join table for classes
  - Create & test models/factories
    - [x] School
      - [x] Update test/code for school_id on user moving to SchoolTeachers table
    - [x] Class
      - [x] Rename to SchoolClass
    - [x] Student
      - [x] Encrypt the name
      - [x] Also add extra levels to enum
        - [x] And to lessons Enum (maybe in concern?)

## February 21st

- [x] Fix Jayson's ACM cert
  - Seems you need to add the CNAME records for subdomains to Route 53, not onamae

#### Deployment

- [x] Configure active record for production
- [x] Configure active storage for production
- [x] Confirm the container can access ENV variables set in EB console
- [x] Add .ebignore
- [x] Resolve some early deploy errors like ${} interpolation not working & docker-compose.yml suddenly reappearing
- [x] Get back to the old problem of deployment timing out
  - Seems EB tries to delete the old container's image while it's still running
  - I think that might be fine though, seems it's maybe intended to fail for images in use?
  - Saw some SO responses suggesting immutable deployments (creating a new instance and replacing the old if successful) might resolve the issue
    - Didn't do the trick on its own, still timing out. But might revisit later if other issues come up
  - Possible the EC2 instance doesn't have enough memory to build the image? Only 500MB and finished image is ~630MB
- [x] Successfully pull & build image manually, then run it by manually passing all env variables
  - Try enabling log streaming to track deploy progress as it happens
- [x] One person seems to have solved slow deploys by just deploying their Dockerfile, which pulls the built image from dockerhub
  - Same timeout error as before
  - [x] Another variant is to just directly upload Dockerrun.aws.json and pull the built image from DockerHub
    - Same issue still
- [x] After just leaving it running for ages, try upgrading the instance class for more memory
  - Didn't work, not ruling memory out as an issue yet though
- When I leave it for ages I get 'The following resource(s) failed to create: [AWSEBInstanceLaunchWaitCondition]', but all the SO answers/AWS guidance for that talks about not having an internet gateway on your VPC, which I do. So pretty sure I need to figure out why it's timing out instead.

## February 22nd

### Seasonal Site

- [x] Line graph of daily inquiries (per month/school/area)
- [x] Average for all schools on the all schools one

### Materials Site

- Memory is an issue on the smallest instance, the container seems to sit around 600MB so we'll need at least 1GB of RAM

- [x] Successful deploy!
- [x] [Add swap](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/container-swap.html) to dockerrun.aws.json
  - Didn't work
- [x] Sort out this msgpack issue that's causing bootsnap to fail (but only in the docker image)
  - Seems to appear when I remove the interpolation from the Bun version???????? Wtf??????
  - Think it's because the step after is the one with the issue, so changing a prior step causes it to be rebuilt rather than pulled from cache
  - Maybe because I locked all the gem versions
  - [x] `--no-cache` seemed to solve it, then wasn't needed after. Also bookmarked some more.

#### Lessons

- [x] Make adding comments to proposed changes actually work

## February 23rd

- [] Look into the Normalize API for data that needs massaging
- [] Add language toggle
  - Maybe just use JS to switch the locale in the URL

#### Sales/OrgAdmin

- Scaffold Schools, Students & Classes
  - Create & test policies
    - [] SchoolPolicy
    - [] ClassPolicy
    - [] StudentPolicy
  - [] Create & system test controller/views
    - [] SchoolsController
    - [] ClassesController
    - [] StudentsController
- Support
  - Org Admins & SMs can message support
  - Sales, curriculum and admins can view/respond to support messages
  - Display notifications for support messages

#### Courses

- Course price is per student, so need an easy way to calculate that
- Needs to have a week from on the plan so they can't see stuff from before the week they started paying
- [] Only show a month in advance of lessons by default as its paid by month
  - Probably need a field for months paid on the plan

#### Students

- Update student level when level check updates
- Student limit on the plan as we're charging by student
  - They can only add students up to the limit

### [Seasonal Registration Site](https://github.com/Brett-Tanner/db_prototype_v2.git)

- [] Redirect or bounce emails to the automated email address

##### Testing

- Write tests for Invoice#calc_cost to prepare for the rewrite
  - Summary
    - [] Test that event options are removed from blank invoices
      - They're currently shown, and the registration remains on the invoice, but not charged for
      - Did not end up doing this because the logic is too entangled
      - Obvious solution is to mark them for destruction in orphan option check, but that's also used with hashes, not just models
      - So can't call #mark_for_destruction, #destroy or set the \_destroy flag
  - [] PDF creation (or at least that one is created)
- Rewrite Invoice#calc_cost as separate classes for cost calculation, summary generation and PDF creation
  - Can test it separately with unit tests till ready, then swap it in when done
- [] Refactor request specs to use rails path helpers
- [] Test emails with [email_spec](https://github.com/email-spec/email-spec) gem
- [] Create `rails predeploy` task to run all the tests and brakeman prior to deployments

#### HAML Refactors

- []

#### Future Plans

- [] Add a table showing a summary of inquiries per month and type, as well as total per month [like this](https://docs.google.com/spreadsheets/d/1fcCN4togDFfhgDeuver5Ts-Javrq_s-RI0b_qRcJc3k/edit#gid=1456240236)
- [] Allow for varying price list courses by automatically determining max/intervals in invoice calc
- [] Overwrite the sign in path properly as well
  - Can use `stored__location_for` to redirect to originally requested page
- [] Uncomment `config.force_ssl` in production, we're already redirecting to HTTPS and the other stuff is good
- [] Investigate what happens if you upload a new asset with the same key as an existing one
- [] When importing the historical setsu/inquiries, try insert/upsert_all with record_timestamps: false to set our own created at
- [] In August 2022, RDS certificate [expires](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL-certificate-rotation.html#UsingWithRDS.SSL-certificate-rotation-updating). Will need to rotate to avoid connectivity issues.
- [] Move control of the domain from Onamae to Cloudflare
- Platform Upgrades
  - TEST ALL ON STAGING FIRST
  - [] Bump AWS platform version
    - [] And enable YJIT
  - [] Try bumping Ruby version to latest stable (can maybe install manually with a pre-deploy hook)
- [] Add button to generate photo service armband PDF for parties
  - Printable template with kids' names and a color which shows their photo status

##### ActiveRecord

- Look into [delegated types](https://api.rubyonrails.org/classes/ActiveRecord/DelegatedType.html)
  - [] especially for splitting the mess of user logic into more manageable chunks
- Maybe use [#store](https://api.rubyonrails.org/classes/ActiveRecord/Store.html) on models with JSON, seems to give a nicer API
  - [] price lists
  - [] surveys
  - [] maybe email preferences
- Can use has_one on a has_many to single out a specific important record
  - [] Next event
  - [] Active invoice
- Rather than manually setting `_destroy`, use `#mark_for_destruction`
  - [] Will be used by invoice calculations, maybe in the confirm controller too?
- You can define methods on associations either by nesting them within a block for that association or defining a class method on the model like `self.my_method`
  - Lets me pass parameters to an operation on an association
  - But I think this is basically just scopes no?
  - Apparently can define a scope on children like `scope :event_invoices, ->(name) { where(event_name: name) }`
- More specific to what I've needed before, you can pass params to scopes by just putting brackets with the params after the '->'
  - Can also put these in modules for re-use, could be handy for stuff like dates that are on everything
  - [] Definitely useful somewhere in the Charts/Stats section of the site
- validates_acceptance_of creates a virtual attribute which must be true for the record to be saved
  - [] add to User for backend validation of privacy policy
- You can chain a list of validations on a single column, like `validates presence: true, uniqueness: true ... etc.`
- Use SQL strings, or maybe the active_record_import gem to update children

##### Optimisation

- [] Nest the confirm_invoice view inside the new route so it's confirm_new_invoice_path

```
resources :invoices do
  new do
    post :confirm
  end
end
```

- [] Similarly, I could do school filtering by nesting those resources inside the school resource.
- [] Use #fetch and #dig in the controller rather than conditionals about the existence of a param, since they can have a default value if not found
- See if the occasional memory problems are actually something more like [this](https://www.engineyard.com/blog/thats-not-a-memory-leak-its-bloat/)
  - [] Also loading all the TimeSlots and Options from the start when calculating Invoice costs
  - [] Also maybe Rack::Bug, or a newer version of something similar since it was last updated in 2015
- Simplify/modularize invoice code
  - [] Split out PDF functionality
  - [] Preload all the stuff I need for calc_cost at the start and pass it explicitly
  - [] Create columns for each type of cost?
- [] use read/write_attribute or bracked notation in my custom getters/setters
  - Not sure what I'm using now, but probably not those
- [] Use AWS Cloudfront to serve images?
- [] Can probably speed up queries for ChartController with pluck
- [] If indexing FK columns which can be null, exclude null from the index

##### Views

- [] Extract conditonal info display into its own partial
  - Already done for the child one, just make more general for parents & move to shared folder
- [] Remember you can use partials in turbo-stream responses, I'm sure there's some stuff to clean up there
- [] Move set_shared_vars in the mailer to a before_action, is fine to apply to all mailers I think
- [] Use @layer to section off old BS styles so I can switch to tailwind
  - But both tailwind and BS using !important liberally might make that problematic
- [] Use `current_page` helpers in partials to conditionally render stuff like diff school selection on event partial
- [] Add a photo_for helper to encapsulate nil checks for associated images and return empty string if missing
- [] Check for missing translations with `i18n-tasks`
- [] Remove locale param from number_to_currency calls, shouldn't need it
- [] number_to_phone_number exists
- [] there's also a number_to_percentage helper, but may be more verbose than what I'm doing now
- [] Change the current event#show to be Invoice#new, since that's what it really is
  - [] Rework the current add_slot partials into a container, morning and afternoon
    - They can likely use fieldsets (with a form attribute matching the invoice form's id) to be submitted with the form directly
    - reduces the JS I need on that page [MDN](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/fieldset)
- [] If you wanna show fallback content (like on the invoice index) use `render 'partial' || 'fallback text/content'`
- [] Extract form error messages into a shared partial
- [] Potentially also extract fields shared between multiple models into a partial (e.g. names for kids/parents)
  - Or just partials for each type of form group? As a fieldset
- [] Apparently there are undocumented ControllerHelper methods I can use to generate the ID for for main elements
- [] Use time_tag helper when outputting date or time, generates a `time` element which apparently is a thing
- [] Use number_to_human_size when I add the blob index etc.

### [Setsumeikai Calendar](https://github.com/Brett-Tanner/setsumeikai_calendar)

Text for Online card in React:

楽しみながら学べるおうちで英会話！
KidsUPのレッスンをご家庭で！
お子様の学びをサポートするコンテンツを
豊富にご用意しております。

- [] Remove back button from summary screen
- Add online trial lessons to setsu registration form
  - [] Make it possible to edit Online's school info
  - [] Add the necessary info
  - [] Send that info in API responses
  - [] Add SM accounts (if necessary) for Online
